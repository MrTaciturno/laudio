<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Reconhecimento de Áudio</title>
</head>
<body>
  <h1>Reconhecimento de Áudio</h1>
  <button id="start-btn">Iniciar Reconhecimento</button>
  <button id="stop-btn" disabled>Parar</button>
  <br><br>

  <label for="caixa-texto">Texto reconhecido:</label><br>
  <textarea id="caixa-texto" rows="5" cols="60" readonly></textarea>
  <br><br>

  <label for="caixa-dimensoes" style="display: block;">Texto (Dimensões):</label>
  <textarea id="caixa-dimensoes" rows="3" cols="60" readonly style="background: #eef2fa"></textarea>

  <p id="resultado" style="display: none;"></p>

  <script>
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    const resultado = document.getElementById('resultado');
    const caixaTexto = document.getElementById('caixa-texto');
    const caixaDimensoes = document.getElementById('caixa-dimensoes');

    // Verifica compatibilidade
    window.SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    let recognition = null;
    let estaReconhecendo = false;

    // Controle para modo de anotação de dimensões
    let modoDimensoes = false;
    let textoDimensoes = '';
    let textoNormal = '';

    // Mapeamento para as pontuações por palavra falada
    const pontuacoesPorPalavra = {
      "vírgula": ",",
      "virgula": ",",
      "ponto e vírgula": ";",
      "ponto final": ".",
      "ponto": "."
    };

    // Função para transformar números em extenso (de 0 a 99, ou centenas simples)
    function numeroPorExtensoPTBR(n) {
      const unidades = ["zero","um","dois","três","quatro","cinco","seis","sete","oito","nove"];
      const dezenas10 = ["dez","onze","doze","treze","quatorze","quinze","dezesseis","dezessete","dezoito","dezenove"];
      const dezenas = ["","","vinte","trinta","quarenta","cinquenta","sessenta","setenta","oitenta","noventa"];
      const centenas = ["cem","cento","duzentos","trezentos","quatrocentos","quinhentos","seiscentos","setecentos","oitocentos","novecentos"];
      n = parseInt(n);
      if (isNaN(n)) return "";
      if (n < 10) return unidades[n];
      if (n < 20) return dezenas10[n-10];
      if (n < 100) {
        let dez = Math.floor(n/10);
        let uni = n % 10;
        if (uni === 0) return dezenas[dez];
        return dezenas[dez] + " e " + unidades[uni];
      }
      if (n === 100) return centenas[0];
      if (n < 200) {
        if (n % 100 === 0) {
          return centenas[0];
        }
        return "cento e " + numeroPorExtensoPTBR(n - 100);
      }
      if (n < 1000) {
        let cen = Math.floor(n/100);
        let rest = n % 100;
        if (rest === 0) return centenas[cen];
        return centenas[cen] + " e " + numeroPorExtensoPTBR(rest);
      }
      // Números acima de 999 apenas valor numérico
      return n;
    }

    function substituirPontuacoesEExtenso(texto) {
      // Substituir palavras de pontuação (inclusive compostas) por sinais
      // 1. Ponto e vírgula
      texto = texto.replace(/\b(ponto e vírgula|ponto e virgula)\b/gi, ";");
      // 2. Ponto final
      texto = texto.replace(/\b(ponto final)\b/gi, ".");
      // 3. Vírgula
      texto = texto.replace(/\b(vírgula|virgula)\b/gi, ",");
      // 4. Ponto (apenas como palavra isolada, não parte de "ponto e vírgula", etc)
      texto = texto.replace(/\b(ponto)\b/gi, function(match, offset, str) {
        // Não substitui "ponto" que já virou ponto final
        // Verifica se já foi substituído
        // Se houver ". " imediatamente antes, pula.
        if (offset > 0 && (str[offset-1] === "." || str[offset-2] === ".")) return match;
        return ".";
      });
      // Números por extenso
      texto = texto.replace(/(\d+)/g, function(match) {
        return match + " (" + numeroPorExtensoPTBR(match) + ")";
      });
      return texto;
    }

    function comandoParar() {
      if (estaReconhecendo) {
        recognition.stop();
        estaReconhecendo = false;
        startBtn.disabled = false;
        stopBtn.disabled = true;
      }
    }

    // comandos de parada do modo dimensões (incluindo singular e plural)
    const comandosDimensoesFim = [
      'FIM'
    ];

    function checarComandos(transcript) {
      const texto = transcript.trim().toUpperCase();
      if (texto === "PARAR" || texto.endsWith(" PARAR")) {
        comandoParar();
        return true; // comando foi acionado
      }
      return false;
    }

    function iniciaModoDimensoes() {
      modoDimensoes = true;
      textoDimensoes = '';
      caixaDimensoes.value = '';
    }

    function encerraModoDimensoes() {
      modoDimensoes = false;
      // O texto já está em caixaDimensoes, nada adicional por enquanto
    }

    function incluiTranscrito(texto, isFinal) {
      // função para distribuição do texto entre as caixas dependendo do modo
      let textoProcessado = substituirPontuacoesEExtenso(texto);
      if (modoDimensoes) {
        textoDimensoes += textoProcessado;
        caixaDimensoes.value = textoDimensoes;
      } else {
        textoNormal += textoProcessado;
        caixaTexto.value = textoNormal;
      }
    }

    if ('SpeechRecognition' in window) {
      recognition = new window.SpeechRecognition();
      recognition.lang = 'pt-BR';
      recognition.interimResults = true;
      recognition.maxAlternatives = 1;
      recognition.continuous = true;

      startBtn.onclick = function() {
        if (!estaReconhecendo) {
          recognition.start();
          estaReconhecendo = true;
          startBtn.disabled = true;
          stopBtn.disabled = false;
          caixaTexto.value = '';
          caixaDimensoes.value = '';
          resultado.style.display = "none";
          textoDimensoes = '';
          textoNormal = '';
          modoDimensoes = false;
        }
      };

      stopBtn.onclick = function() {
        comandoParar();
      };

      recognition.onresult = function(event) {
        let interimNormal = '';
        let interimDimensoes = '';
        for (let i = event.resultIndex; i < event.results.length; ++i) {
          let transcript = event.results[i][0].transcript;
          let isFinal = event.results[i].isFinal;
          let textoUp = transcript.trim().toUpperCase();

          // Checar "PARAR"
          if (isFinal && checarComandos(transcript)) {
            continue;
          }

          // Identificar início do modo dimensões
          if (!modoDimensoes && textoUp.includes("DIMENSÕES")) {
            iniciaModoDimensoes();
            // O trecho "dimensões" pode continuar algo após, já colocar o resto em dimensões se houver
            let pos = textoUp.indexOf("DIMENSÕES");
            let resto = transcript.substring(pos + "DIMENSÕES".length).trimStart();
            if (resto.length > 0) {
              let restoProc = substituirPontuacoesEExtenso(resto + " ");
              if (isFinal) {
                textoDimensoes += restoProc;
                caixaDimensoes.value = textoDimensoes;
              } else {
                interimDimensoes += restoProc;
              }
            }
            // O trecho antes de "dimensões" vai no texto normal, se houver
            let antes = transcript.substring(0, pos).trim();
            if (antes.length > 0) {
              let antesProc = substituirPontuacoesEExtenso(antes + " ");
              if (isFinal) {
                textoNormal += antesProc;
                caixaTexto.value = textoNormal;
              } else {
                interimNormal += antesProc;
              }
            }
            continue;
          }

          // Se estamos no modo dimensões, procurar comandos de fim
          if (modoDimensoes) {
            // Se no resultado final há um comando de fim, encerra modo, o texto até o comando vai para caixa de dimensões, o resto volta ao texto normal
            let fimIdx = -1;
            let comandoEncontrado = "";
            for (let cmd of comandosDimensoesFim) {
              let idx = textoUp.indexOf(cmd);
              if (idx !== -1 && (fimIdx === -1 || idx < fimIdx)) {
                fimIdx = idx;
                comandoEncontrado = cmd;
              }
            }
            if (fimIdx !== -1) {
              // textoDimensoes pega até o comando, texto normal o resto após comando
              let ateFim = transcript.substring(0, fimIdx).trimEnd();
              let aposFim = transcript.substring(fimIdx + comandoEncontrado.length).trimStart();
              if (ateFim.length > 0) {
                let ateFimProc = substituirPontuacoesEExtenso(ateFim + " ");
                if (isFinal) {
                  textoDimensoes += ateFimProc;
                  caixaDimensoes.value = textoDimensoes;
                } else {
                  interimDimensoes += ateFimProc;
                }
              }
              // sai do modo dimensões
              encerraModoDimensoes();
              if (aposFim.length > 0) {
                let aposFimProc = substituirPontuacoesEExtenso(aposFim + " ");
                if (isFinal) {
                  textoNormal += aposFimProc;
                  caixaTexto.value = textoNormal;
                } else {
                  interimNormal += aposFimProc;
                }
              }
              continue;
            } else {
              // Se não encontrou comando de fim, vai para dimensões
              let trProc = substituirPontuacoesEExtenso(transcript + " ");
              if (isFinal) {
                textoDimensoes += trProc;
                caixaDimensoes.value = textoDimensoes;
              } else {
                interimDimensoes += trProc;
              }
              continue;
            }
          }

          // Fora do modo dimensões: texto comum
          let trProc = substituirPontuacoesEExtenso(transcript + " ");
          if (isFinal) {
            textoNormal += trProc;
            caixaTexto.value = textoNormal;
          } else {
            interimNormal += trProc;
          }
        }
        // Atualiza o texto das caixas de texto com interinos
        if (!modoDimensoes && interimNormal) {
          caixaTexto.value = textoNormal + interimNormal;
        }
        if (modoDimensoes && interimDimensoes) {
          caixaDimensoes.value = textoDimensoes + interimDimensoes;
        }
      };

      recognition.onerror = function(event) {
        resultado.style.display = "";
        resultado.textContent = 'Erro: ' + event.error;
        startBtn.disabled = false;
        stopBtn.disabled = true;
        estaReconhecendo = false;
      };

      recognition.onend = function() {
        // Só reinicia se o usuário não tiver pedido para parar
        if (estaReconhecendo) {
          try {
            recognition.start();
          } catch (e) {}
        } else {
          startBtn.disabled = false;
          stopBtn.disabled = true;
        }
      };
    } else {
      resultado.style.display = "";
      resultado.textContent = "Reconhecimento de voz não suportado neste navegador.";
      startBtn.disabled = true;
      stopBtn.disabled = true;
    }
  </script>
</body>
</html>
